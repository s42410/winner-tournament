<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>ניהול קבוצות</title>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      background: linear-gradient(to bottom right, #74ebd5, #acb6e5);
      padding: 40px;
      text-align: center;
    }
    .box {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.25);
      padding: 30px;
      display: inline-block;
      width: 750px;
      max-width: 95%;
    }
    input, select {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 16px;
      margin: 4px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-save { background-color: #22cc71; color: white; }
    .btn-house { background-color: #f39c12; color: white; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h3>📋 יצירת קבוצה</h3>
    <input type="text" id="name" placeholder="שם קבוצה" required />
    <input type="text" id="color" placeholder="צבע מדים" required />
    <input type="text" id="house" placeholder="בית (אם מופעל)" style="display:none;" />
    <button id="saveBtn" class="btn-save">💾 שמור קבוצה</button>
    <button id="houseBtn" class="btn-house">🏠 צור פורמט בתים</button>
    <div id="message"></div>

    <table>
      <thead>
        <tr>
          <th>שם קבוצה</th>
          <th>צבע</th>
          <th id="houseHeader" style="display:none;">בית</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="teamsTable"></tbody>
    </table>
  </div>

  <script>
    let showHouse = false;

    document.getElementById('houseBtn').onclick = () => {
      showHouse = true;
      document.getElementById('house').style.display = 'block';
      document.getElementById('houseHeader').style.display = 'table-cell';
      fetchTeams();
    };

    const tournamentId = new URLSearchParams(window.location.search).get("tournamentId");
    const tableBody = document.getElementById("teamsTable");
    const message = document.getElementById("message");
    let editId = null;

    async function fetchTeams() {
      const res = await fetch(`/api/teams/${tournamentId}`);
      const data = await res.json();
      tableBody.innerHTML = "";
      data.forEach(team => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${team.name}</td>
          <td>${team.color}</td>
          <td style="display:${showHouse ? 'table-cell' : 'none'};" ondblclick="editHouse('${team._id}', this)">${team.house || ''}</td>
          <td>
            <button onclick="editTeam('${team._id}', '${team.name}', '${team.color}', '${team.house || ''}')">✏️</button>
            <button onclick="deleteTeam('${team._id}', '${team.name}')">🗑️</button>
            <button onclick="goToPlayers('${team._id}')">👥</button>
          </td>`;
        tableBody.appendChild(row);
      });
    }

    async function saveTeam() {
      const name = document.getElementById("name").value.trim();
      const color = document.getElementById("color").value.trim();
      const house = showHouse ? document.getElementById("house").value.trim() : "";
      if (!name || !color) {
        message.textContent = "❌ נא למלא שם וצבע!";
        return;
      }

      const url = editId ? `/api/teams/${editId}` : "/api/teams";
      const method = editId ? "PUT" : "POST";
      const body = { name, color, house, tournamentId };

      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (res.ok) {
        message.textContent = "✅ נשמר בהצלחה!";
        document.getElementById("name").value = "";
        document.getElementById("color").value = "";
        document.getElementById("house").value = "";
        editId = null;
        fetchTeams();
      } else {
        message.textContent = "❌ שגיאה: " + data.error;
      }
    }

    function editTeam(id, name, color, house) {
      document.getElementById("name").value = name;
      document.getElementById("color").value = color;
      if (showHouse) document.getElementById("house").value = house;
      editId = id;
    }

    async function deleteTeam(id, name) {
      if (!confirm(`למחוק את הקבוצה "${name}"?`)) return;
      const res = await fetch(`/api/teams/${id}`, { method: "DELETE" });
      if (res.ok) {
        message.textContent = "✅ נמחק בהצלחה";
        fetchTeams();
      } else {
        const data = await res.json();
        message.textContent = "❌ שגיאה: " + data.error;
      }
    }

    function goToPlayers(id) {
      window.location.href = `/admin-players.html?teamId=${id}`;
    }

    async function editHouse(id, cell) {
      const oldHouse = cell.textContent.trim();
      const input = document.createElement("input");
      input.value = oldHouse;
      cell.innerHTML = "";
      cell.appendChild(input);
      input.focus();
      input.addEventListener("keyup", async (e) => {
        if (e.key === "Enter") {
          const newHouse = input.value.trim();
          const res = await fetch(`/api/teams/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ house: newHouse })
          });
          if (res.ok) {
            cell.textContent = newHouse;
          } else {
            cell.textContent = oldHouse;
          }
        }
      });
    }

    document.getElementById("saveBtn").onclick = saveTeam;
    fetchTeams();
  </script>
</body>
</html>
