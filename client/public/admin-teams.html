<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>⚽ ניהול קבוצות</title>
  <style>
    body {
      direction: rtl;
      background: linear-gradient(to bottom right, #74ebd5, #acb6e5);
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
    }

    .logo {
      width: 220px;
    }

    .box {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
      padding: 30px;
      display: inline-block;
      width: 750px;
      max-width: 95%;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 5px;
    }

    .btn-save { background: #22cc71; color: white; }
    .btn-house { background: #ff9800; color: white; }
    .btn-back {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #3498db; color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
    }

    .success { color: green; margin-top: 10px; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <button class="btn-back" onclick="history.back()">🔙 חזור</button>
  <img src="logo.png" class="logo" alt="logo">
  <div class="box">
    <h2>⚽ יצירת קבוצה</h2>
    <input type="text" id="name" placeholder="שם קבוצה" required>
    <input type="text" id="color" placeholder="צבע מדיה" required>
    <input type="text" id="house" placeholder="בית (רשות)" style="display:none;">
    <button onclick="addHouseField()" class="btn-house">🏠 צור פורמט בתים</button>
    <button onclick="saveTeam()" class="btn-save">💾 שמור קבוצה</button>
    <button onclick="saveAllChanges()" class="btn-save">💾 שמור שינויים</button>
    <div id="message"></div>

    <table>
      <thead>
        <tr>
          <th>שם קבוצה</th>
          <th>צבע</th>
          <th>בית</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody id="teamsTable"></tbody>
    </table>
  </div>

  <script>
    let editId = null;
    let houseEnabled = false;

    const tournamentId = new URLSearchParams(window.location.search).get('tournamentId');
    const msg = document.getElementById('message');
    const houseField = document.getElementById('house');

    function addHouseField() {
      houseEnabled = true;
      houseField.style.display = 'block';
      document.querySelectorAll('.houseInput').forEach(e => e.style.display = 'inline');
    }

    async function fetchTeams() {
      const res = await fetch(`/api/teams/${tournamentId}`);
      const data = await res.json();
      const tbody = document.getElementById('teamsTable');
      tbody.innerHTML = '';
      data.forEach(team => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><input type="text" value="${team.name}" class="editName"></td>
          <td><input type="text" value="${team.color}" class="editColor"></td>
          <td><input type="text" value="${team.house || ''}" class="houseInput" ${houseEnabled ? '' : 'style="display:none;"'}></td>
          <td>
            <button onclick="editTeam('${team._id}')">✏️</button>
            <button onclick="deleteTeam('${team._id}')">🗑️</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function saveTeam() {
      const name = document.getElementById('name').value.trim();
      const color = document.getElementById('color').value.trim();
      const house = houseField.value.trim();

      if (!name || !color) {
        msg.textContent = '❌ נא למלא שם וצבע';
        msg.className = 'error';
        return;
      }

      const res = await fetch('/api/teams', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, color, house, tournamentId })
      });

      const data = await res.json();
      if (res.ok) {
        msg.textContent = '✅ נוספה קבוצה';
        msg.className = 'success';
        fetchTeams();
      } else {
        msg.textContent = '❌ ' + data.error;
        msg.className = 'error';
      }
    }

    async function saveAllChanges() {
      const rows = document.querySelectorAll('#teamsTable tr');
      for (const row of rows) {
        const id = row.querySelector('button').getAttribute('onclick').match(/'(.*?)'/)[1];
        const name = row.querySelector('.editName').value.trim();
        const color = row.querySelector('.editColor').value.trim();
        const house = row.querySelector('.houseInput').value.trim();
        await fetch(`/api/teams/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, color, house })
        });
      }
      msg.textContent = '✅ כל השינויים נשמרו';
      msg.className = 'success';
      fetchTeams();
    }

    async function editTeam(id) {
      editId = id;
    }

    async function deleteTeam(id) {
      await fetch(`/api/teams/${id}`, { method: 'DELETE' });
      fetchTeams();
    }

    fetchTeams();
  </script>
</body>
</html>
